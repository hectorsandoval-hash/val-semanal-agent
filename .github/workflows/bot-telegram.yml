name: Bot Telegram (Tiempo Real)

on:
  schedule:
    # Lunes a Viernes, cada turno de 5 horas durante horario laboral
    # Peru = UTC-5
    # 9AM Peru = 14:00 UTC  (turno 1: 9AM-2PM)
    # 2PM Peru = 19:00 UTC  (turno 2: 2PM-6PM)
    - cron: '0 14 * * 1-5'
    - cron: '0 19 * * 1-5'

  # Ejecutar manualmente
  workflow_dispatch:

# Solo una instancia del bot a la vez
concurrency:
  group: telegram-bot
  cancel-in-progress: true

jobs:
  bot-polling:
    runs-on: ubuntu-latest
    timeout-minutes: 340  # ~5.6 horas (max GitHub Actions = 6h)

    env:
      PYTHONUNBUFFERED: '1'

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Instalar requests
        run: pip install requests

      - name: Descargar datos privados (resumen + preferencias)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Funcion para descargar artifact de un workflow
          download_artifact() {
            local WORKFLOW=$1
            local ARTIFACT_NAME=$2
            echo "Buscando artifact '$ARTIFACT_NAME' de $WORKFLOW..."

            RUN_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW/runs?status=success&per_page=1" \
              | python3 -c "import sys,json; runs=json.load(sys.stdin).get('workflow_runs',[]); print(runs[0]['id'] if runs else '')" 2>/dev/null || echo "")

            if [ -z "$RUN_ID" ]; then
              echo "  No hay runs exitosos de $WORKFLOW"
              return 1
            fi

            ARTIFACT_URL=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts" \
              | python3 -c "
          import sys, json
          arts = json.load(sys.stdin).get('artifacts', [])
          for a in arts:
              if a['name'] == '$ARTIFACT_NAME' and not a.get('expired', False):
                  print(a['archive_download_url'])
                  break
          " 2>/dev/null || echo "")

            if [ -z "$ARTIFACT_URL" ]; then
              echo "  No se encontro artifact '$ARTIFACT_NAME'"
              return 1
            fi

            curl -L -s -H "Authorization: token $GITHUB_TOKEN" -o _tmp.zip "$ARTIFACT_URL"
            unzip -o _tmp.zip -d . 2>/dev/null && echo "  $ARTIFACT_NAME descargado OK" || echo "  Error descomprimiendo"
            rm -f _tmp.zip
          }

          # Descargar resumen.json del pipeline
          download_artifact "val-semanal.yml" "resumen-data"
          [ -f resumen.json ] && echo "  resumen.json: $(wc -c < resumen.json) bytes"

          # Descargar preferencias.json de la ejecucion anterior del bot
          download_artifact "bot-telegram.yml" "preferencias-data"
          [ -f preferencias.json ] && echo "  preferencias.json: $(wc -c < preferencias.json) bytes"

          echo "Descarga completada."

      - name: Test API GitHub Models
        env:
          GH_MODELS_TOKEN: ${{ secrets.GH_MODELS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Diagnostico ==="
          echo "GH_MODELS_TOKEN: $([ -n \"$GH_MODELS_TOKEN\" ] && echo 'SI ('${#GH_MODELS_TOKEN}' chars)' || echo 'NO')"
          echo "GITHUB_TOKEN: $([ -n \"$GITHUB_TOKEN\" ] && echo 'SI' || echo 'NO')"
          TOKEN_TO_USE="${GH_MODELS_TOKEN:-$GITHUB_TOKEN}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://models.inference.ai.azure.com/chat/completions" \
            -H "Authorization: Bearer $TOKEN_TO_USE" \
            -H "Content-Type: application/json" \
            -d '{"model":"gpt-4o-mini","messages":[{"role":"user","content":"di hola"}],"max_tokens":10}')
          echo "API Test: HTTP $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "OK - API funciona"
          else
            echo "WARN - API fallo con codigo $HTTP_CODE"
          fi

      - name: Ejecutar bot en modo polling
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_MODELS_TOKEN: ${{ secrets.GH_MODELS_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
          MAX_RUNTIME_HOURS: '5'
          HORA_FIN: '23'
        run: python bot_polling_worker.py

      - name: Guardar preferencias como artefacto
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preferencias-data
          path: preferencias.json
          retention-days: 90
          if-no-files-found: ignore
          overwrite: true
